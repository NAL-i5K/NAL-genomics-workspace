{% extends "app/layout.html" %}
{% load staticfiles %}
{% load jsonify %}

{% block head-scripts %}
<!--<link rel="stylesheet" type="text/css" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">-->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
<style>
#fieldset-user-account {float:left;}
#fieldset-user-info {float:left;padding-left: 20px;}
#fieldset-user-detail-button {float:left;padding-left: 20px;}
.operation-button {padding-bottom: 10px;}
#fieldset-group-info {float:left;padding-left: 20px;}
#fieldset-group-detail-button {float:left;padding-left: 20px;}
.group-oper-button {padding-bottom: 10px;}
</style>
{% endblock%}

{% block scripts %}
<script src="{% static 'blast/scripts/underscore-min.js' %}"></script>
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->
<script src="http://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.5/js/bootstrap-dialog.min.js"></script>
<script>
$(document).ready(function() {

    //cookie handlers
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    var table = $('#userTable').DataTable({
        "processing":true,
        "paging":true,
        "deferRender": true,
        "ajax": {
            "url" : 'http://10.11.210.63:8000/sso/getUsers',
            "dataSrc": ""
        },
        "columns": [
            {"data":"username"},
            {"data":"firstName"},
            {"data":"lastName"},
            {"data":"role"},
            {"data":"groups[,].name"},
            {"data":"groups[,].name"},
            {"data":"userId"},
            {"data":"availableGroups[,].name"},
            {"data":"djangoUser"},
            {"data":"organismPermissions[,].organism"},
            //{"data":"organismPermissions[,].permissions"},
        ],
        "columnDefs": [{
            "aTargets": [4], // Column to target
            "mRender": function ( data, type, full ) {
                text = '';
                var str = data.split(",");
                for (i = 0; i < str.length; i++){
                    var patt = /GROUP_(\w+)_ADMIN/g;
                    if(patt.test(str[i]) == true){
                        var organism = str[i].split("_")[1];
                        text += organism + ",";
                    }
                }
                return '<a href="' + data  + '" target="_blank">' + text + '</a>';
            }},{
            "aTargets": [5], // Column to target
            "mRender": function ( data, type, full ) {
                text = '';
                var str = data.split(",");
                for (i = 0; i < str.length; i++){
                    var patt = /GROUP_(\w+)_USER/g;
                    if(patt.test(str[i]) == true){
                        var organism = str[i].split("_")[1];
                        text += organism + ",";
                    }
                }
                return '<a href="' + data  + '" target="_blank">' + text + '</a>';
            }},
        ],
        "order": [[ 6, "asc" ]],
        "fnDrawCallback": function (oSettings) {
            //clear all browser's auto completion
            $('#fieldset-user-reset').click();
        },
    });

    table.column(7).visible(false);

    $('a.toggle-vis').on( 'click', function (e) {
            e.preventDefault();
            var column = table.column( $(this).attr('data-column') );
            column.visible( ! column.visible() );
    });

    var hasSelected = false;
    $('#userTable tbody').on( 'click', 'tr', function () {
        
        hasSelected = true;
        if ( $(this).hasClass('selected') ) {
            //$(this).removeClass('selected');
        }
        else {
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
        
        $('#fieldset-user-detail-username').val(table.cell(table.row(this).index(),0).data());
        $('#fieldset-user-detail-firstname').val(table.cell(table.row(this).index(),1).data());
        $('#fieldset-user-detail-lastname').val(table.cell(table.row(this).index(),2).data());
        $('#fieldset-user-detail-role').val(table.cell(table.row(this).index(),3).data());
        $('#fieldset-user-django-user').val('');
        $('#fieldset-user-detail-password').val('');
        
        text = "";
        str = table.cell(table.row(this).index(),4).data().split(",");
        if(str != ""){
            for (i = 0; i < str.length; i++){
                text += "<button type='button' class='btn btn-danger user-group-button' value='" + str[i] + "'>" + str[i] + "</button> ";
            }
        }
        $('#user-group-now-group').html(text);

        text = "";
        str = table.cell(table.row(this).index(),7).data().split(",");
        if(str != ""){
            for (i = 0; i < str.length; i++){
                text += "<button type='button' class='btn btn-success user-group-button' value='" + str[i] + "'>" + str[i] + "</button> ";
            }
        }
        $('#user-group-avaiable-group').html(text);
    } );


    $('#user-group').delegate('.user-group-button','click',function(){
        userId = table.cell(table.row(table.$('tr.selected')).index(),6).data();
        userName = table.cell(table.row(table.$('tr.selected')).index(),0).data();
        groupName = $(this).val();

        if($(this).hasClass('btn-danger') == true){
            $(this).removeClass('btn-danger');
            $(this).addClass('btn-success');

            $.ajax({
                type: "POST",
                url: 'http://10.11.210.63:8000/sso/remove_user_from_group',
                data: { groupName: groupName , user: userName, userId: userId},
                success: function(data){
                    //table.ajax.reload();
                }
            });
            
        }else if($(this).hasClass('btn-success') == true){
            $(this).removeClass('btn-success');
            $(this).addClass('btn-danger');
            
            $.ajax({
                type: "POST",
                url: 'http://10.11.210.63:8000/sso/add_user_to_group',
                data: { groupName: groupName , user: userName, userId: userId},
                success: function(data){
                    //table.ajax.reload();
                }
            });
            
        } 
    });

    var table_group = $('#groupTable').DataTable({
         "ajax": {
            "url" : 'http://10.11.210.63:8000/sso/getGroups',
            "dataSrc": ""
        },
        "columns": [
            {"data":"name"},
            {"data":"numberOfUsers"},
            {"data":"public"},
            {"data":"id"},
        ],
        "order": [[ 0, "desc" ]],
    });

    $('#groupTable tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }else {
            table_group.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }

        groupName = table_group.cell(table_group.row(this).index(),0).data();
        var organism = '';
        var patt = /GROUP_(\w+)_USER|GROUP_(\w+)_ADMIN/g;
        if(patt.test(groupName) == true){
            organism = groupName.split("_")[1];
        }

        $('#fieldset-group-detail-username').val(organism);
        $('#group-admin-name').text("GROUP_" + organism + "_ADMIN");
        $('#group-user-name').text("GROUP_" + organism + "_USER");
    });

    $('#fieldset-group-create-button').on('click', function(){
        if($('#fieldset-group-create-button').val() == 'Create'){
            $('#fieldset-group-detail-username').val('');
            $('#fieldset-group-create-button').val('Save');
            $('#fieldset-group-cancel-button').removeClass('hide'); 
        }else if($('#fieldset-group-create-button').val() == 'Save'){
            BootstrapDialog.confirm({
                message: 'You\'re going to create group , are you sure?',
                type: BootstrapDialog.TYPE_WARNING,
                callback : function(result){ 
                    if(result) {
                        $.ajax({
                            type: "POST",
                            url: 'http://10.11.210.63:8000/sso/create_group_for_organism',
                            data: {oname : $('#fieldset-group-detail-username').val()},
                            success: function(data){
                                alert();
                            }
                        }); 
                    }
                }
            }); 


            $('#fieldset-group-create-button').val('Create');
            $('#fieldset-group-cancel-button').addClass('hide');
        }    
    });

    $('#fieldset-group-cancel-button').on('click', function(){
        $('#fieldset-group-detail-username').val('');
        $('#fieldset-group-create-button').val('Create');
        $('#fieldset-group-cancel-button').addClass('hide');
    }); 

    $('#fieldset-group-delete-button').on('click', function(){
        oid = table_group.cell(table_group.row(this).index(),3).data();
        BootstrapDialog.confirm({
            message: 'You\'re going to delete group , are you sure?',
            type: BootstrapDialog.TYPE_WARNING,
            callback : function(result){
                if(result) {
                    $.ajax({
                        type: "POST",
                        url: 'http://10.11.210.63:8000/sso/delete_group_for_organism',
                        data: {oname : $('#fieldset-group-detail-username').val(), oid : oid},
                        success: function(data){
                             alert();
                        }
                    });
                }
            }
        });
    }); 




    $.getJSON("http://10.11.210.63:8000/sso/getMyOrganism", function(data){
        var items = [];
        $.each( data, function( key, val ) {
            if(val == true){
                name = key.split("_")[0]
                oid  = key.split("_")[1]
                items.push( "<legend style='font-size:20px; padding-top:20px'>" + name +
                    " <button type='button' class='btn btn-primary' onclick='myFunction()'>Owner</button>" +
                    " <button type='button' class='btn btn-success'>Launch</button>" +
                    "</legend>" +
                    "<p><a href='#" + name + "-user-collapse' data-toggle='collapse' id='" + name + "' class='userlink'>User Collapsible</a>" +
                    "<div id='" + name + "-user-collapse' class='collapse'>" +
                    "<table id='table" + name + "' class='display' cellspacing='0' width='100%' load='none' id='" + name + "' oid = '" + oid + "' oname='" + name + "'><thead><tr>" +
                    "<th>UserName</th><th>FirstName</th><th>LastName</th><th>Role</th><th>Species_Admin</th><th>Species_User</th><th>Organism</th><th>Permission</th><th>UserId</th><th>action</th>" +
                    "</tr></thead></table></div>" +
                    "<a href='#" + name + "-pending-request-collapse' data-toggle='collapse' id='" + name + "' oid = '" + oid + "' class='pendinglink'>Pending Request Collapsible</a>" +
                    "<div id='" + name + "-pending-request-collapse' class='collapse'>" +
                    "<table id='tableRequest" + name + "' class='display tableRequest' cellspacing='0' width='100%' load='none' oid='" + oid + "' oname='" + name + "'><thead><tr>" +
                    "<th>UserName</th><th>FirstName</th><th>LastName</th><th>Role</th><th>Species_Admin</th><th>Species_User</th><th>userID</th><th>Action</th>" +
                    "</tr></thead></table></div>"
                    );
            }else{
                 name = key.split("_")[0]
                 items.push( "<legend style='font-size:20px; padding-top:20px'>" + name +
                    " <button type='button' class='btn btn-info'>Info</button>" +
                    " <button type='button' class='btn btn-success'>Launch</button>" +
                    "</legend>" +
                    "<a href='#" + name + "-owner-info-collapse' data-toggle='collapse' id='test'>Info Collapsible</a>" +
                    "<div id='" + name + "-owner-info-collapse' class='collapse'></div>"
                    );
            }
        });

        $( items.join( "" )
        ).appendTo( $("#myOrganism") );

    })

    var table_request = $('#requestTable').DataTable({
        "processing":true,
        //"serverSide": true,
        "ajax": {
            "url" : 'http://10.11.210.63:8000/sso/getMyRequest',
            "dataSrc": ""
        },
        "columns": [
            {"data":"commonName"},
            {"data":"species"},
            {"data":"genus"},
            {"data":"valid"},
            {"data":"id"},
            {"data":"admin"},
            {"data":"action"},
        ],
        "columnDefs": [{
            "aTargets": [6], // Column to target
            "mRender": function ( data, type, full ) {
                if(data == 'REQUEST'){
                    return '<button type="button" class="btn btn-primary action">request</button>'
                }else if(data == 'RELEASE'){
                    return '<button type="button" class="btn btn-danger action">release</button>'
                }else if(data == 'W_REQUEST'){
                    return '<button type="button" class="btn btn-primary action">requesting</button>'
                }else if(data == 'W_RELEASE'){
                    return '<button type="button" class="btn btn-danger action">releaseing</button>'
                }else{
                    return ''
                }

            }}
        ],
    });

    $('#requestTable tbody').on( 'click', 'td', function () {
        //alert(table_request.cell(this).data());
    });

    $('#myOrganism').delegate('.userlink','click',function(){

        tablename = "table" + $(this).attr('id');

        if($('#' + tablename).attr("load") == "none"){

            $('#' + tablename).attr("load","OK");

            var table = $('#' + tablename).DataTable({
                "processing":true,
                //"serverSide": true,
                "ajax": {
                    "url" : 'http://10.11.210.63:8000/sso/getUsers?organism=' + $(this).attr('id'),
                    "dataSrc": ""
                },
                "columns": [
                    {"data":"username"},
                    {"data":"firstName"},
                    {"data":"lastName"},
                    {"data":"role"},
                    {"data":"groups[,].name"},
                    {"data":"groups[,].name"},
                    {"data":"organismPermissions[,].organism"},
                    {"data":"organismPermissions[,].permissions"},
                    {"data":"userId"},
                    {"data":"admin"}
                ],
                "columnDefs": [{
                    "aTargets": [4], // Column to target
                    "mRender": function ( data, type, full ) {
                        text = '';
                        var str = data.split(",");
                        for (i = 0; i < str.length; i++){
                            var patt = /GROUP_(\w+)_ADMIN/g;
                            if(patt.test(str[i]) == true){
                                var organism = str[i].split("_")[1];
                                text += organism + ",";
                            }
                        }
                        return '<a href="' + data  + '" target="_blank">' + text + '</a>';
                    }},{
                    "aTargets": [5], // Column to target
                    "mRender": function ( data, type, full ) {
                        text = '';
                        var str = data.split(",");
                        for (i = 0; i < str.length; i++){
                            var patt = /GROUP_(\w+)_USER/g;
                            if(patt.test(str[i]) == true){
                                var organism = str[i].split("_")[1];
                                text += organism + ",";
                            }
                        }
                        return '<a href="' + data  + '" target="_blank">' + text + '</a>';
                    }},{
                    "aTargets": [9], // Column to target
                    "mRender": function ( data, type, full ) {
                        if(data == false){
                            return '<button type="button" class="btn btn-danger user-manage-button">release</button>'
                        }else{
                            return ''
                        }
                    }},
                ],
                "order": [[ 8, "asc" ]],
            });
        }
    })


    $('#myOrganism').delegate('.pendinglink','click',function(){

        tablename = "tableRequest" + $(this).attr('id');

        if($('#' + tablename).attr("load") == "none"){

            $('#' + tablename).attr("load","OK");

                var table = $('#' + tablename).DataTable({
                "processing":true,
                //"serverSide": true,
                "ajax": {
                    "url" : 'http://10.11.210.63:8000/sso/getPendingRequest?oid=' + $(this).attr('oid'),
                    "dataSrc": ""
                },
                "columns": [
                    {"data":"username"},
                    {"data":"firstName"},
                    {"data":"lastName"},
                    {"data":"role"},
                    {"data":"groups[,].name"},
                    {"data":"groups[,].name"},
                    {"data":"userId"},
                    {"data":"action"}
                ],
                "columnDefs": [{
                    "aTargets": [4], // Column to target
                    "mRender": function ( data, type, full ) {
                        text = '';
                        var str = data.split(",");
                        for (i = 0; i < str.length; i++){
                            var patt = /GROUP_(\w+)_ADMIN/g;
                            if(patt.test(str[i]) == true){
                                var organism = str[i].split("_")[1];
                                text += organism + ",";
                            }
                        }
                        return '<a href="' + data  + '" target="_blank">' + text + '</a>';
                    }},{
                    "aTargets": [5], // Column to target
                    "mRender": function ( data, type, full ) {
                        text = '';
                        var str = data.split(",");
                        for (i = 0; i < str.length; i++){
                            var patt = /GROUP_(\w+)_USER/g;
                            if(patt.test(str[i]) == true){
                                var organism = str[i].split("_")[1];
                                text += organism + ",";
                            }
                        }
                        return '<a href="' + data  + '" target="_blank">' + text + '</a>';
                    }},{
                    "aTargets": [7], // Column to target
                    "mRender": function ( data, type, full ) {
                        if(data == 'REQUEST'){
                            return '<button type="button" class="btn btn-primary pending-request-button" action="ACCEPT">request-accept</button>' + ' <button type="button" class="btn btn-primary pending-request-button" action="REFUSE">request-refuse</button>'
                        }else if(data == 'RELEASE'){
                            return '<button type="button" class="btn btn-danger pending-request-button" action="ACCEPT">release-accept</button>' + ' <button type="button" class="btn btn-danger pending-request-button"action="REFUSE">release-refuse</button>'
                        }else{
                            return ''
                        }
                    }}
                ],
            });
        }
    })

    $('#myOrganism').delegate('.pending-request-button','click',function(){
        var current_column = this.parentElement;
        var current_row = current_column.parentElement;
        var table_name = current_row.parentElement.parentElement.id;
        var oid = $(current_row.parentElement.parentElement).attr("oid");
        var oname = $(current_row.parentElement.parentElement).attr("oname");
        var action = $(this).attr("action");
        var table = $('#'+table_name).DataTable();

        var idx = table.row(current_row).index();
        var name  = table.cell(idx,0).data();
        var userId = table.cell(idx,6).data();

        BootstrapDialog.confirm({
            title: 'Are you sure you want to do that?',
            message: $('<textarea class="form-control" maxlength="100" placeholder="Type the reason that you do this here... (<100 words)"></textarea>'),
            type: BootstrapDialog.TYPE_WARNING, 
            closable: true, 
            draggable: true, 
            btnOKClass: 'btn-warning', 
            callback: function(result) {
                if(result) {
                    $.ajax({
                    type: "POST",
                    url: 'http://10.11.210.63:8000/sso/handleRequest',
                    data: { action: action, oid : oid , oname: oname , user: name, userId: userId, reply_desc : $('.form-control').val()},
                    success: function(data){
                        table.ajax.reload();
                        }
                    });            
                }
            }
        });
    })

    $('#myOrganism').delegate('.user-manage-button','click',function(){
        var current_column = this.parentElement;
        var current_row = current_column.parentElement;
        var table_name = current_row.parentElement.parentElement.id;
        var table = $('#'+table_name).DataTable();
        var oid = $(current_row.parentElement.parentElement).attr("oid");
        var oname = $(current_row.parentElement.parentElement).attr("oname");
        
        var idx = table.row(current_row).index();
        var userId = table.cell(idx,8).data();
        var name  = table.cell(idx,0).data();

        BootstrapDialog.confirm({
            title: 'Are you sure you want to do that?',
            message: $('<textarea class="form-control"  maxlength="100" placeholder="Type the reason that you do this here... (<100 words)"></textarea>'),
            type: BootstrapDialog.TYPE_WARNING, 
            closable: true, 
            draggable: true, 
            btnOKClass: 'btn-warning', 
            callback: function(result) {
                if(result) {
                    $.ajax({
                    type: "POST",
                    url: 'http://10.11.210.63:8000/sso/removeUserFromGroup',
                    data: { oid : oid , oname: oname , user: name, userId: userId, reason : $('.form-control').val()},
                    success: function(data){
                        table.ajax.reload();
                        }
                    });            
                }
            }
        });
    })


    $('#myRequest').delegate('.action','click',function(){
        var action = table_request.cell(this.parentElement).data();
        var idx = table_request.row(this.parentElement.parentElement).index();
        var oid  = table_request.cell(idx,4).data();

        BootstrapDialog.confirm({
            title: 'Are you sure you want to do that?',
            message: $('<textarea class="form-control" maxlength="100" placeholder="Type the reason that you do this here... (<100 words)"></textarea>'),
            type: BootstrapDialog.TYPE_WARNING, 
            closable: true, 
            draggable: true, 
            btnOKClass: 'btn-warning', 
            callback: function(result) {
                if(result) {
                    $.ajax({
                    type: "POST",
                    url: 'http://10.11.210.63:8000/sso/makeRequest',
                    data: { oid: oid , action: action, apply_desc : $('.form-control').val()},
                    success: function(data){
                        table_request.ajax.reload();
                        }
                    });    
                }
            }
        });
    })


    $('#fieldset-user-create-button').on('click', function(){
        if($('#fieldset-user-create-button').val() == 'Create'){
            $('#fieldset-user-cancel-button').click();
            $('#fieldset-user-create-button').val('Save');
            $('#fieldset-user-cancel-button').removeClass('hide');
            disableButtons();
            $('#fieldset-user-create-button').prop('disabled', false);
            $('#fieldset-user-cancel-button').prop('disabled', false);
        }else if($('#fieldset-user-create-button').val() == 'Save'){
            firstName = $('#fieldset-user-detail-firstname').val();
            lastName  = $('#fieldset-user-detail-lastname').val();
            userName  = $('#fieldset-user-detail-username').val();
            password  = $('#fieldset-user-detail-password').val();    
            djangoUserName = $('#fieldset-user-django-user').val();

            BootstrapDialog.confirm({
                message: 'You\'re going to create user ' + userName + ', are you sure?',
                type: BootstrapDialog.TYPE_WARNING,
                callback : function(result){ 
                    if(result) {
                        $.ajax({
                            type: "POST",
                            url: 'http://10.11.210.63:8000/sso/createUser',
                            data: {firstName : firstName, lastName : lastName, userName : userName, password : password, djangoUserName : djangoUserName},
                            success: function(data){
                                var result = $.parseJSON(data);
                                if(jQuery.isEmptyObject(result)){
                                    BootstrapDialog.alert("Create user " + userName +  " success!");
                                    table.ajax.reload();
                                    $('#fieldset-user-cancel-button').click();
                                    hasSelected = false;
                                }else if('error' in result){
                                    BootstrapDialog.alert({
                                        title: 'ERROR',
                                        message: result['error'], 
                                        type: BootstrapDialog.TYPE_DANGER, 
                                    });
                                }
                            }
                        }); 
                    }
                }
            }); 

            $('#fieldset-user-create-button').val('Create');
            $('#fieldset-user-cancel-button').addClass('hide');
            $('#fieldset-user-update-button').prop('disabled', false);
            $('#fieldset-user-delete-button').prop('disabled', false); 
        }
    });

    $('#fieldset-user-cancel-button').on('click', function(){
        $('#fieldset-user-detail-username').val('');
        $('#fieldset-user-detail-firstname').val('');
        $('#fieldset-user-detail-lastname').val('');
        $('#fieldset-user-detail-role').prop('selectedIndex', 0);
        $('#fieldset-user-django-user').val('');
        $('#fieldset-user-create-button').val('Create');
        $('#fieldset-user-cancel-button').addClass('hide');
        enableButtons();
        $('#checkDjangoUserIcon').removeClass();
        $('#fieldset-user-detail-password').val('');
    });


    $('#fieldset-user-delete-button').on('click', function(){
        if(!hasSelected)return;
        userId = table.cell(table.row(table.$('tr.selected')).index(),6).data();

        BootstrapDialog.confirm({
            message: 'You\'re going to delete user ' + userId + ', are you sure?',
            type: BootstrapDialog.TYPE_WARNING,
            callback : function(result){ 
                if(result) {
                    $.ajax({
                        type: "POST",
                        url: 'http://10.11.210.63:8000/sso/deleteUser',
                        data: {userId : userId},
                        success: function(data){
                            table.ajax.reload();
                            $('#fieldset-user-cancel-button').click();
                            hasSelected = false;
                        }
                    }); 
                }
            }
        });        

   });

    $('#fieldset-user-update-button').on('click', function(){
        if(!hasSelected)return;
        userId = table.cell(table.row(table.$('tr.selected')).index(),6).data();
        firstName = $('#fieldset-user-detail-firstname').val();
        lastName  = $('#fieldset-user-detail-lastname').val();
        userName  = $('#fieldset-user-detail-username').val();
        role      = $('#fieldset-user-detail-role').val();
        password  = $('#fieldset-user-detail-password').val();
        djangoUserName = $('#fieldset-user-django-user').val();

        BootstrapDialog.confirm({
            message: 'You\'re going to update user ' + userId + ', are you sure?',
            type: BootstrapDialog.TYPE_WARNING,
            callback : function(result){ 
                if(result) {
                    $.ajax({
                        type: "POST",
                        url: 'http://10.11.210.63:8000/sso/updateUser',
                        data: {userId : userId, firstName : firstName, lastName : lastName, userName : userName, role : role, password : password, djangoUserName : djangoUserName},
                        success: function(data){
                            var result = $.parseJSON(data);
                            if(jQuery.isEmptyObject(result)){
                                BootstrapDialog.alert("Update user " + userName +  " success!");
                                table.ajax.reload();
                                $('#fieldset-user-cancel-button').click();
                                hasSelected = false;
                            }else if('error' in result){
                                BootstrapDialog.alert({
                                    title: 'ERROR',
                                    message: result['error'], 
                                    type: BootstrapDialog.TYPE_DANGER, 
                                });
                            }
                        }
                    }); 
                }
            }
        });        
    });
    
    $('#fieldset-user-disconnect-button').on('click', function(){
        if(!hasSelected)return;
        userId = table.cell(table.row(table.$('tr.selected')).index(),6).data();
        firstName = $('#fieldset-user-detail-firstname').val();
        lastName  = $('#fieldset-user-detail-lastname').val();
        userName  = $('#fieldset-user-detail-username').val();
        role      = $('#fieldset-user-detail-role').val();

        BootstrapDialog.confirm({
            message: 'You\'re going to disconnect user ' + userId + ', are you sure?',
            type: BootstrapDialog.TYPE_WARNING,
            callback : function(result){ 
                if(result) {
                    $.ajax({
                        type: "POST",
                        url: 'http://10.11.210.63:8000/sso/disconnect_user',
                        data: {userId : userId},
                        success: function(data){
                            var result = $.parseJSON(data);
                            if(jQuery.isEmptyObject(result)){
                                BootstrapDialog.alert("Disconnect user " + userName +  " success!");
                                table.ajax.reload();
                                $('#fieldset-user-cancel-button').click();
                                hasSelected = false;
                            }else if('error' in result){
                                BootstrapDialog.alert({
                                    title: 'ERROR',
                                    message: result['error'], 
                                    type: BootstrapDialog.TYPE_DANGER, 
                                });
                            }
                        }
                    }); 
                }
            }
        });        
    });

    function disableButtons(){
        $('.user-button').prop('disabled', true);
    }

    function enableButtons(){
        $('.user-button').prop('disabled', false);
    }

    $('#fieldset-user-group-reload').on('click', function(){
        table.ajax.reload(); 
    });

    $('#fieldset-user-reset').on('click', function(){
        enableButtons();
        $('#fieldset-user-cancel-button').click();
        hasSelected = false;
    });

    var chooseProgram = _.debounce(function () {
        disableButtons();
        if($('#fieldset-user-django-user').val() == ''){
            enableButtons();
            $('#checkDjangoUserIcon').removeClass();
            return true;
        }
        
        $.ajax({
            type: "POST",
            url: 'http://10.11.210.63:8000/sso/check_django_user_available',
            data: {userName : $('#fieldset-user-django-user').val()},
            success: function(data){
                $('#checkDjangoUserIcon').removeClass();
                if(data['result'] == true){
                    $('#checkDjangoUserIcon').addClass("fa fa-check");
                    enableButtons();
                }else{
                    $('#checkDjangoUserIcon').addClass("fa fa-close");
                }
            }
        });
    }, 200);

    $('#fieldset-user-django-user').keyup(chooseProgram);
} );
</script>
{% endblock%}


{% block content %}
<div class="container">
    <h2>Web Apollo SSO</h2>
    <ul class="nav nav-tabs">
        {% if is_admin %}
        <li class='active'><a data-toggle="tab" href="#myUser">User(Admin)</a></li>
        <li><a data-toggle="tab" href="#myGroup">Group(Admin)</a></li>
        <li><a data-toggle="tab" href="#myOrganism">My Organism</a></li>
		<li><a data-toggle="tab" href="#myRequest">My Request</a></li>
        {% else %}
        <li class='active'><a data-toggle="tab" href="#myOrganism">My Organism</a></li>
        <li><a data-toggle="tab" href="#myRequest">My Request</a></li>
        {% endif %}
    </ul>

    <div class="tab-content">
        {% if is_admin %}
        <div id="myUser" class="tab-pane fade in active">
        {% else %}
        <div id="myUser" class="tab-pane fade hide">
        {% endif %}
            <legend style="font-size:20px; padding-top:20px">User Table</legend>
            <a class="toggle-vis" data-column="4">Species_Admin</a> -
            <a class="toggle-vis" data-column="5">Species_User</a> -
            <a class="toggle-vis" data-column="6">UserId</a> -
            <table id="userTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>UserName</th>
                        <th>FirstName</th>
                        <th>LastName</th>
                        <th>Role</th>
                        <th>Species_Admin</th>
                        <th>Species_User</th>
                        <th>UserId</th>
                        <th>AvaiableGroup</th>
                        <th>I5kUserName</th>
                         
                        <th>Organism</th>
                        <!--
                        <th>Permission</th>
                        -->
                    </tr>
                </thead>
            </table>
			<p>
			<fieldset id="main">
			<legend>User Info</legend>
			<div class="container">
				<ul class="nav nav-pills">
                    <li class="active"><a data-toggle="tab" href="#user-detail">Detail</a></li>
                    <li><a data-toggle="tab" href="#user-group">Group</a></li>
                    <!--<li><a data-toggle="tab" href="#user-organism">Organism</a></li>-->
                </ul>
                <div class="tab-content">
                    <div id="user-detail" class="tab-pane fade in active">
						<fieldset id="fieldset-user-account">
							<div style="font-size:16px; padding-top:16px">Apollo User Name</div>
							<input type="text" name="user-name" id="fieldset-user-detail-username">
                            <div style="font-size:16px;">I5k User Name</div>
                            <input type="text" name="user-django-user" id="fieldset-user-django-user"> <span aria-hidden="true" style="color:red" id="checkDjangoUserIcon"></span>
							<div style="font-size:16px;">Password</div>
							<input type="password" name="user-password" id="fieldset-user-detail-password">
						</fieldset>
						<fieldset id="fieldset-user-info">
                            <div style="font-size:16px; padding-top:16px">First Name</div>
							<input type="text" name="first-name" id="fieldset-user-detail-firstname">
							<div style="font-size:16px">Last Name</div>
							<input type="text" name="last-name" id="fieldset-user-detail-lastname">
                            <div style="font-size:16px">Role</div>
                            <select name="role" id="fieldset-user-detail-role"><option value="USER">USER</option><option value="ADMIN">ADMIN</option></select>
						</fieldset>
						<fieldset id="fieldset-user-detail-button" style="padding-top:20px; padding-bottom:20px">
                            <div class="operation-button"><INPUT TYPE="button" VALUE="Create" class="user-button" id="fieldset-user-create-button"> <INPUT TYPE="button" VALUE="Cancel" id="fieldset-user-cancel-button" class="user-button hide"></div>
							<div class="operation-button"><INPUT TYPE="button" VALUE="Delete" class="user-button" id="fieldset-user-delete-button"></div>
							<div class="operation-button"><INPUT TYPE="button" VALUE="Update" class="user-button" id="fieldset-user-update-button"></div>
						    <div class="operation-button"><INPUT TYPE="button" VALUE="Disconnect" class="user-button" id="fieldset-user-disconnect-button"></div>
                            <div class="operation-button"><INPUT TYPE="button" VALUE="Reset" id="fieldset-user-reset"></div>
                        </fieldset>
					</div>
                    <div id="user-group" class="tab-pane fade">
                        <h3>Group Table</h3>
                        <p id="user-group-now-group"></p>
                        <p> </p>
                        <p id="user-group-avaiable-group"></p>
                        <fieldset id="fieldset-user-group-button" style="padding-top:20px; padding-bottom:20px">
						    <INPUT TYPE="button" VALUE="Reload User Table" id="fieldset-user-group-reload">
                        </fieldset>
                    </div>
                    <!--
                    <div id="user-organism" class="tab-pane fade">
                        <h3>Permission Table</h3>
                        <p id="user-organism-permission"></p>
                        <p> </p>
                        <fieldset id="fieldset-user-organism-button" style="padding-top:20px; padding-bottom:20px">
							<INPUT TYPE="button" VALUE="Update">
						</fieldset>
					</div>
                    -->
                </div>
            </div>
			</fieldset>
        </div>
        {% if is_admin %}
        <div id="myGroup" class="tab-pane fade">
        {% else %}
        <div id="myGroup" class="tab-pane fade hide">
        {% endif %}
            <legend style="font-size:20px; padding-top:20px">Group Table</legend>
            <table id="groupTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Group Name</th>
						<th>Member Numbers</th>
                        <th>Public</th>
                        <th>ID</th>
                    </tr>
                </thead>
            </table>
			<p>
			<fieldset id="main">
			<legend>Group Info</legend>
			<div class="container">
				<ul class="nav nav-pills">
                    <li class="active"><a data-toggle="tab" href="#group-detail">Detail</a></li>
					<li><a data-toggle="tab" href="#group-member">Member</a></li>
                    <li><a data-toggle="tab" href="#group-organism">Organism</a></li>
                </ul>
                <div class="tab-content">
                    <div id="group-detail" class="tab-pane fade in active">
						<fieldset id="fieldset-group-info">
							<div style="font-size:16px; padding-top:16px">Group Name</div>
							<input type="text" name="group-name" id="fieldset-group-detail-username">
                            <div style="font-size:16px; padding-top:10px" id="group-admin-name"></div>
                            <div style="font-size:16px; padding-top:10px" id="group-user-name"></div>
						</fieldset>
						<fieldset id="fieldset-group-detail-button" style="padding-top:20px; padding-bottom:20px">
                            <div class="group-oper-button"><INPUT TYPE="button" VALUE="Create" class="group-button" id="fieldset-group-create-button"> <INPUT TYPE="button" VALUE="Cancel" id="fieldset-group-cancel-button" class="group-button hide"></div>
							<div class="group-oper-button"><INPUT TYPE="button" VALUE="Delete" class="group-button" id="fieldset-group-delete-button"></div>
							<div class="group-oper-button"><INPUT TYPE="button" VALUE="Update" class="group-button" id="fieldset-group-update-button"></div>
                            <div class="group-oper-button"><INPUT TYPE="button" VALUE="Reset" id="fieldset-group-reset"></div>
                        </fieldset>
                    </div>
					<div id="group-member" class="tab-pane fade">
                        <h3>Member Table</h3>
                        <fieldset id="fieldset-group-member-button" style="padding-top:20px; padding-bottom:20px">
							<INPUT TYPE="button" VALUE="Insert">
							<INPUT TYPE="button" VALUE="Delete">
							<INPUT TYPE="button" VALUE="Update">
						</fieldset>
					</div>
                    <div id="group-organism" class="tab-pane fade">
                        <h3>Permission Table</h3>
                        <fieldset id="fieldset-group-organism-button" style="padding-top:20px; padding-bottom:20px">
                            <INPUT TYPE="button" VALUE="Insert">
							<INPUT TYPE="button" VALUE="Delete">
							<INPUT TYPE="button" VALUE="Update">
						</fieldset>
					</div>
                </div>
            </div>
			</fieldset>
        </div>
        {% if is_admin %}
        <div id="myOrganism" class="tab-pane fade">
        {% else %}
        <div id="myOrganism" class="tab-pane fade in active">
        {% endif %}
		</div>
        <div id="myRequest" class="tab-pane fade">
			<legend style="font-size:20px; padding-top:20px">Organism Table</legend>
            <table id="requestTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>CommonName</th>
                        <th>Species</th>
                        <th>Genus</th>
                        <th>Valid</th>
                        <th>ID</th>
                        <th>ADMIN</th>
                        <th>STATUS</th>
                    </tr>
                </thead>
            </table>
		</div>
    </div>
</div>
{% endblock %}
