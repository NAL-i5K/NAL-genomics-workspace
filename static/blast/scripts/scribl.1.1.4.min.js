function ScriblWrapLines(n,t){var f=[],i;t=""+t;var r="",e=0,u=t.split(" ");for(i=0;i<u.length;i++)u[i].length+r.length<=n?r+=" "+u[i]:r==""?(trunc1=u[i].slice(0,n-1),r+=" "+trunc1+"-",trunc2=u[i].slice(n,u[i].length),u.splice(i+1,0,trunc2),f.push(r),r="",e++):(i--,f.push(r),e++,r="");return e++,f.push(r),[f,e]}function genbank(n,t){for(var f,r,c,i,e,a,l=n.split("\n"),v=new RegExp(/\s+gene\s+([a-z]*)\(?(\d+)\.\.(\d+)/),u=[],o=undefined,s=undefined,h=0;h<l.length;h++)(f=l[h].match(v))&&(f.shift(),u.push(f),e=f[2],(o==undefined||o>e)&&(o=e),i=f[1],(s==undefined||s<i)&&(s=i));for(t.scale.max=o,t.scale.min=s,r=0;r<u.length;r++)c="+",u[r][0]=="complement"&&(c="-"),i=u[r][1],e=u[r][2],i=i-0,a=e-i,t.addGene(i,a,c)}function bed(n,t){var f=n.split("\n"),y=undefined,p=undefined,w=f[0],u,r;for(numFeatures=f.length,u=1;u<numFeatures;u++){if(f[u]=="")break;var i=f[u].split(" "),s=parseInt(i[1]),h=parseInt(i[2]),c=i[0]+": "+i[3],o=i[5],l=i[8],e=i[10].split(","),a=i[11].split(","),v=t.addFeature(new Complex("complex",s,h,o,[],{color:l,name:c}));for(r=0;r<e.length;r++){if(e[r]=="")break;v.addSubFeature(new BlockArrow("complex",parseInt(a[r]),parseInt(e[r]),o))}}}var SCRIBL,idCounter;(function(){var n=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(i){function u(){!n&&this.init&&this.init.apply(this,arguments)}var e=this.prototype,f,r;n=!0;f=new this;n=!1;for(r in i)f[r]=typeof i[r]=="function"&&typeof e[r]=="function"&&t.test(i[r])?function(n,t){return function(){var r=this._super,i;return this._super=e[n],i=t.apply(this,arguments),this._super=r,i}}(r,i[r]):i[r];return u.prototype=f,u.constructor=u,u.extend=arguments.callee,u}})();SCRIBL={};SCRIBL.chars={};SCRIBL.chars.nt_color="white";SCRIBL.chars.nt_A_bg="red";SCRIBL.chars.nt_G_bg="blue";SCRIBL.chars.nt_C_bg="green";SCRIBL.chars.nt_T_bg="black";SCRIBL.chars.nt_N_bg="purple";SCRIBL.chars.nt_dash_bg="rgb(120,120,120)";SCRIBL.chars.heights=[];SCRIBL.chars.canvasHolder=document.createElement("canvas");var Scribl=Class.extend({init:function(n,t){var r,i,u,f;this.scrolled=!1;n&&(r=n.getContext("2d"));i=this;this.width=t;this.uid=_uniqueId("chart");this.laneSizes=50;this.laneBuffer=5;this.trackBuffer=25;this.offset=undefined;this.canvas=n;this.ctx=r;this.scale={};this.scale.pretty=!0;this.scale.max=undefined;this.scale.min=undefined;this.scale.auto=!0;this.scale.userControlled=!1;this.scale.positions=[0];this.scale.off=!1;this.scale.size=15;this.scale.font={};this.scale.font.size=15;this.scale.font.color="black";this.scale.font.buffer=10;this.glyph={};this.glyph.roundness=6;this.glyph.borderWidth=1;this.glyph.color=["#99CCFF","rgb(63, 128, 205)"];this.glyph.text={};this.glyph.text.color="black";this.glyph.text.size="13";this.glyph.text.font="arial";this.glyph.text.align="center";this.gene={};this.gene.text={};this.protein={};this.protein.text={};this.events={};this.events.hasClick=!1;this.events.hasMouseover=!1;this.events.clicks=[];this.events.mouseovers=[];this.events.added=!1;this.mouseHandler=function(n){i.handleMouseEvent(n,"mouseover")};this.clickHandler=function(n){i.handleMouseEvent(n,"click")};this.tick={};this.tick.auto=!0;this.tick.major={};this.tick.major.size=10;this.tick.major.color="black";this.tick.minor={};this.tick.minor.size=1;this.tick.minor.color="rgb(55,55,55)";this.tick.halfColor="rgb(10,10,10)";this.tooltips={};this.tooltips.text={};this.tooltips.text.font="arial";this.tooltips.text.size=12;this.tooltips.borderWidth=1;this.tooltips.roundness=5;this.tooltips.fade=!1;this.tooltips.style="light";this.lastToolTips=[];this.scrollable=!1;this.scrollValues=[];this.chars={};this.chars.drawOnBuild=[];this.drawStyle="expand";this.glyphHooks=[];this.trackHooks=[];this.myMouseEventHandler=new MouseEventHandler(this);this.tracks=[];u=this.scale.size;f=this.scale.font.size},getScaleHeight:function(){return this.scale.font.size+this.scale.size},getHeight:function(){var n=0,i,t;for(this.scale.off||(n+=this.getScaleHeight()),i=this.tracks.length,t=0;t<i;t++)n+=this.trackBuffer,n+=this.tracks[t].getHeight();return n},getFeatures:function(){for(var t,i=[],n=0;n<this.tracks.length;n++)for(t=0;t<this.tracks[n].lanes.length;t++)i=i.concat(this.tracks[n].lanes[t].features);return i},setCanvas:function(n){this.canvas=n;this.ctx=n.getContext("2d")},addScale:function(){this.scale.userControlled?this.scale.positions.push(this.tracks.length):(this.scale.positions=[this.tracks.length],this.scale.userControlled=!0)},addTrack:function(){var n=new Track(this);return this.tracks.length==1&&this.tracks[0]==undefined&&(this.tracks=[]),this.tracks.push(n),n},removeTrack:function(n){for(var i=this,t=0;t<i.tracks.length;t++)n.uid==i.tracks[t].uid&&i.tracks.splice(t,1);delete n},loadGenbank:function(n){genbank(n,this)},loadBed:function(n){bed(n,this)},loadBam:function(n,t,i,r,u){var e=this,f=e.addTrack();return f.status="waiting",makeBam(new BlobFetchable(n),new BlobFetchable(t),function(n){e.file=n;n.fetch(i,r,u,function(n,t){if(n){for(var i=0;i<n.length;i+=1)f.addFeature(new BlockArrow("bam",n[i].pos,n[i].lengthOnRef,"+",{seq:n[i].seq}));f.status="received";f.drawOnResponse&&e.redraw()}t&&alert("error: "+t)})}),f},loadFeatures:function(n){for(var t=0;t<n.length;t++)this.addFeature(n[t])},addGene:function(n,t,i,r){return this.addFeature(new BlockArrow("gene",n,t,i,r))},addProtein:function(n,t,i,r){return this.addFeature(new BlockArrow("protein",n,t,i,r))},addFeature:function(n){var t=this.tracks[0]||this.addTrack();return t.addFeature(n),n},slice:function(n,t,i){var c,l,v,y,a,h,u,r,e,o,s;i=i||"inclusive";var w=this,p=this.tracks.length,f=new Scribl(this.canvas,this.width);for(f.scale.min=this.scale.min,f.scale.max=this.scale.max,f.offset=this.offset,f.scale.off=this.scale.off,f.scale.pretty=this.scale.pretty,f.laneSizes=this.laneSizes,f.drawStyle=this.drawStyle,f.glyph=this.glyph,f.glyphHooks=this.glyphHooks,f.trackHooks=this.trackHooks,f.previousDrawStyle=this.previousDrawStyle,c=0;c<p;c++)for(l=this.tracks[c],v=f.addTrack(),v.drawStyle=l.drawStyle,y=l.lanes.length,a=0;a<y;a++)for(h=v.addLane(),u=l.lanes[a].features,r=0;r<u.length;r++)e=u[r].position+u[r].length,o=u[r].position,i=="inclusive"?o>=n&&o<=t?h.addFeature(u[r].clone()):e>n&&e<t?h.addFeature(u[r].clone()):o<n&&e>t?h.addFeature(u[r].clone()):o>n&&e<t&&h.addFeature(u[r].clone()):i=="strict"?o>=n&&o<=t?e>n&&e<t?h.addFeature(u[r].clone()):(s=u[r].glyphType=="BlockArrow"&&u[r].strand=="+"?u[r].clone("Rect"):u[r].clone(),s.length=Math.abs(t-o),h.addFeature(s)):e>n&&e<t?(s=u[r].glyphType=="BlockArrow"&&u[r].strand=="-"?u[r].clone("Rect"):u[r].clone(),s.position=n,s.length=Math.abs(e-n),h.addFeature(s)):o<n&&e>t&&(s=u[r].glyphType=="BlockArrow"?u[r].clone("Rect"):u[r].clone(),s.position=n,s.length=Math.abs(t-n),h.addFeature(s)):i=="exclusive"&&o>=n&&o<=t&&e>n&&e<t&&h.addFeature(u[r].clone());return f},draw:function(){var n=this.ctx,i=this.tracks,t;for(this.initScale(),this.scrollable==!0&&this.initScrollable(),n.save(),this.offset==undefined&&(this.offset=Math.ceil(n.measureText("0").width/2+10)),n.save(),t=0;t<i.length;t++)this.scale.off||this.scale.positions.indexOf(t)==-1||this.drawScale(),i[t].draw();this.scale.off||this.scale.positions.indexOf(i.length)==-1||this.drawScale();n.restore();n.restore();this.events.added||this.registerEventListeners()},redraw:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.tracks.length>0&&this.draw()},initScale:function(){this.scale.pretty&&(this.tick.auto&&(this.tick.major.size=this.determineMajorTick(),this.tick.minor.size=Math.round(this.tick.major.size/10)),this.scale.auto&&(this.scale.min-=this.scale.min%this.tick.major.size,this.scale.max=Math.round(this.scale.max/this.tick.major.size+.4)*this.tick.major.size))},drawScale:function(n){var u,t=this.ctx,o=t.fillStyle,i,l,r,e;n&&n.init&&this.initScale();var f=this.scale.font.size+this.scale.size,s=this.scale.font.size+2,h=this.scale.font.size+this.scale.size*.66,c=this.scale.font.size+this.scale.size*.33;for(t.font=this.scale.font.size+"px arial",t.textBaseline="top",t.fillStyle=this.scale.font.color,this.offset==undefined&&(this.offset=Math.ceil(t.measureText("0").width/2+10)),u=this.scale.min%this.tick.minor.size==0?this.scale.min:this.scale.min-this.scale.min%this.tick.minor.size+this.tick.minor.size,i=u;i<=this.scale.max;i+=this.tick.minor.size)t.beginPath(),i==187250&&(l=2),r=this.pixelsToNts(i-this.scale.min)+this.offset,i%this.tick.major.size==0?(e=this.getTickText(i),t.textAlign="center",t.fillText(e,r,0),t.moveTo(r,f),t.lineTo(r,s),t.strokeStyle=this.tick.major.color,t.stroke()):(t.moveTo(r,f),i%(this.tick.major.size/2)==0?(t.strokeStyle=this.tick.halfColor,t.lineTo(r,c)):(t.strokeStyle=this.tick.minor.color,t.lineTo(r,h)),t.stroke());t.fillStyle=o;t.translate(0,this.getScaleHeight()+this.laneBuffer)},pixelsToNts:function(n){return n==undefined?this.width/(this.scale.max-this.scale.min):this.width/(this.scale.max-this.scale.min)*n},ntsToPixels:function(n){return n==undefined?1/this.pixelsToNts():n/this.width},initScrollable:function(){var n=this.canvas.parentNode,o,r,i,e;n.className!="scroll-wrapper"&&(o=n,this.canvas.style.cssText="",r=document.createElement("div"),r.className="slider",r.style.cssFloat="left",r.style.margin="32px 13px",r.style.position="absolute",o.replaceChild(r,this.canvas),n=document.createElement("div"),n.style.width="100%",n.style.height="100%",n.style.overflow="auto",n.className="scroll-wrapper",n.appendChild(this.canvas),o.appendChild(n),jQuery(n).dragscrollable({dragSelector:"canvas:first",acceptPropagatedEvent:!1}));this.scrollValues.length<2&&(this.scrollValues=[this.scale.min,this.scale.max]);var u=this.scale.max-this.scale.min,s=this.scrollValues[1]-this.scrollValues[0],h=u/s,t=$(n).width(),f=this.offset;this.canvas.width=(t-this.offset*2)*h+this.offset*2;this.width=this.canvas.width-this.offset*2;n.scrollLeft=(this.scrollValues[0]-this.scale.min)/u*this.width;i=this;e=u*10+this.offset*2;e<t&&(e=t);jQuery(this.canvas.parentNode.previousElementSibling).slider({orientation:"vertical",range:"min",max:e,min:t,value:this.width,slide:function(r,e){var o=u/(e.value-f*2),s=u*(n.scrollLeft+t/2-f)/(i.canvas.width-f*2),h=s-(t/2-f)*o,c=s+(t/2-f)*o;i.scrollValues=[h,c];i.ctx.clearRect(0,0,i.canvas.width,i.canvas.height);i.draw()}})},determineMajorTick:function(){this.ctx.font=this.scale.font.size+"px arial";var u=this.width/(this.ctx.measureText(this.getTickTextDecimalPlaces(this.scale.max)).width+this.scale.font.buffer),t=(this.scale.max-this.scale.min)/u,i=Math.pow(10,parseInt(t).toString().length-1);this.tick.major.size=Math.ceil(t/i)*i;var f=(this.tick.major.size+"").length,r=Math.pow(10,f),n=this.tick.major.size/r;return n>.1&&n<=.5?n=.5:n>.5&&(n=1),n*r},getTickText:function(n){var t,r,i;return this.tick.auto?(t=n,n>=1e6?(r=5,i=Math.pow(10,r),t=Math.round(t/1e6*i)/i+"m"):n>=1e3&&(r=2,i=Math.pow(10,r),t=Math.round(t/1e3*i)/i+"k"),t):n},getTickTextDecimalPlaces:function(n){var t,i;return this.tick.auto?(t=n,n>=1e6?(i=5,t=Math.round(t/(1e6/Math.pow(10,i)))+"m"):n>=1e3&&(i=2,t=Math.round(t/(1e3/Math.pow(10,i)))+"k"),t):n},handleMouseEvent:function(n,t){var o,r,u,s,a,h,e,f,c,l,i;for(this.myMouseEventHandler.setMousePosition(n),o=this.myMouseEventHandler.mouseY,i=0;i<this.tracks.length;i++)for(u=0;u<this.tracks[i].lanes.length;u++)if(s=this.tracks[i].lanes[u].getPixelPositionY(),a=s+this.tracks[i].lanes[u].getHeight(),o>=s&&o<=a){r=this.tracks[i].lanes[u];break}if(r){if(h=r.track.getDrawStyle(),h=="collapse")this.redraw();else if(h!="line"){for(this.ctx.save(),r.erase(),this.ctx.translate(0,r.getPixelPositionY()),r.draw();e=this.lastToolTips.pop();)this.ctx.putImageData(e.pixels,e.x,e.y);this.ctx.restore()}if(f=this,t=="click")for(c=f.events.clicks,i=0;i<c.length;i++)c[i](f);else for(l=f.events.mouseovers,i=0;i<l.length;i++)l[i](f);this.myMouseEventHandler.reset(f)}},addClickEventListener:function(n){this.events.clicks.push(n)},addMouseoverEventListener:function(n){this.events.mouseovers.push(n)},removeEventListeners:function(n){n=="mouseover"?this.canvas.removeEventListener("mousemove",this.mouseHandler):n=="click"&&this.canvas.removeEventListener("click",this.clickHandler)},registerEventListeners:function(){var n=this;this.events.mouseovers.length>0&&(this.canvas.removeEventListener("mousemove",n.mouseHandler),this.canvas.addEventListener("mousemove",n.mouseHandler,!1));this.events.clicks.length>0&&(this.canvas.removeEventListener("click",n.clickHandler),this.canvas.addEventListener("click",n.clickHandler,!1));this.events.added=!0}}),Track=Class.extend({init:function(n){var i=this,t;for(this.chart=n,this.lanes=[],this.ctx=n.ctx,this.uid=_uniqueId("track"),this.drawStyle=undefined,this.hide=!1,this.hooks={},t=0;t<n.trackHooks.length;t++)this.addDrawHook(n.trackHooks[t]);this.coverageData=[];this.maxDepth=0},addLane:function(){var n=new Lane(this.ctx,this);return this.lanes.push(n),n},addGene:function(n,t,i,r){return this.addFeature(new BlockArrow("gene",n,t,i,r))},addProtein:function(n,t,i,r){return this.addFeature(new BlockArrow("protein",n,t,i,r))},addFeature:function(n){for(var i,f,r,u=!0,t=0;t<this.lanes.length;t++)if(i=this.lanes[t].features[this.lanes[t].features.length-1],f=3/this.chart.pixelsToNts()||3,i!=undefined&&n.position-f>i.position+i.length){u=!1;r=this.lanes[t];break}return u&&(r=this.addLane()),r.addFeature(n),n},hide:function(){this.hide=!0},unhide:function(){this.hide=!1},getDrawStyle:function(){return this.drawStyle?this.drawStyle:this.chart.drawStyle},getHeight:function(){var t=0,i=this.lanes.length,r=this.chart.laneBuffer,u=this.getDrawStyle(),n;for((u=="line"||u=="collapse")&&(i=1),n=0;n<i;n++)t+=r,t+=this.lanes[n].getHeight();return t-r},getPixelPositionY:function(){for(var n=this,i=n.chart.scale.off?0:n.chart.getScaleHeight()+n.chart.laneBuffer,t=0;t<n.chart.tracks.length;t++){if(n.uid==n.chart.tracks[t].uid)break;i+=n.chart.trackBuffer;i+=n.chart.tracks[t].getHeight()}return i},calcCoverageData:function(){for(var i,f,c,n,u=this.lanes,e=this.chart.scale.min,o=this.chart.scale.max,t=0;t<u.length;t++)for(i=0;i<u[t].features.length;i++){var r=u[t].features[i],s=r.position,h=r.getEnd();if(s>=e&&s<=o||h>=e&&h<=o)for(f=Math.round(r.getPixelPositionX()),c=Math.round(f+r.getPixelLength()),n=f;n<=c;n++)this.coverageData[n]=this.coverageData[n]+1||1,this.maxDepth=Math.max(this.coverageData[n],this.maxDepth)}},erase:function(){var n=this;n.chart.ctx.clearRect(0,n.getPixelPositionY(),n.chart.width,n.getHeight())},draw:function(){var n=this,l=!1,v,i,t,f,p,o,c;for(t in n.hooks)l=n.hooks[t](n)||l;if(n.status=="waiting"){n.drawOnResponse=!0;return}if(!n.hide){var s=n.getDrawStyle(),h=n.chart.laneSizes,r=n.lanes,e=n.chart.laneBuffer,y=n.chart.trackBuffer,a=h+y,u=n.chart.ctx;if(!l)if(s==undefined||s=="expand")for(t=0;t<r.length;t++)r[t].y=a,r[t].draw()&&(v=r[t].getHeight(),u.translate(0,v+e),a=a+v+e);else if(s=="collapse"){for(i=[],t=0;t<r.length;t++)i=i.concat(r[t].filterFeaturesByPosition(n.chart.scale.min,n.chart.scale.max));for(i.sort(function(n,t){return n.position-t.position}),f=0;f<i.length;f++){var w=i[f].length,b=i[f].name,k=undefined;i[f].draw();i[f].length=w;i[f].name=b}r.length>0&&u.translate(0,r[0].getHeight()+e)}else if(s=="line"){for(n.coverageData=[],n.coverageData.length==0&&n.calcCoverageData(),p=this.maxDepth,u.beginPath(),o=this.chart.offset;o<=this.chart.width+this.chart.offset;o++)c=n.coverageData[o]/p*h||0,c=h-c,u.lineTo(o,c);u.lineTo(this.chart.width+this.chart.offset,h);u.stroke();u.translate(0,r[0].getHeight()+e)}u.translate(0,y-e)}},addDrawHook:function(n,t){var i=t||_uniqueId("drawHook");return this.hooks[i]=n,i},removeDrawHook:function(n){delete this.hooks[n]}}),Lane=Class.extend({init:function(n,t){this.height=undefined;this.features=[];this.ctx=n;this.track=t;this.chart=t.chart;this.uid=_uniqueId("lane")},addGene:function(n,t,i,r){return this.addFeature(new BlockArrow("gene",n,t,i,r))},addProtein:function(n,t,i,r){return this.addFeature(new BlockArrow("protein",n,t,i,r))},addFeature:function(n){return n.lane=this,this.features.push(n),this.chart[n.type]||(this.chart[n.type]={text:{}}),(n.length+n.position>this.chart.scale.max||!this.chart.scale.max)&&(this.chart.scale.max=n.length+n.position),(n.position<this.chart.scale.min||!this.chart.scale.min)&&(this.chart.scale.min=n.position),n},loadFeatures:function(n){for(var i=n.length,t=0;t<i;t++)this.addFeature(n[t])},getHeight:function(){return this.height!=undefined?this.height:this.chart.laneSizes},getPixelPositionY:function(){for(var n=this,t=n.track.getPixelPositionY(),r=n.getHeight(),i=0;i<n.track.lanes.length;i++){if(n.uid==n.track.lanes[i].uid)break;t+=n.track.chart.laneBuffer;t+=r}return t},erase:function(){var n=this;n.chart.ctx.clearRect(0,n.getPixelPositionY(),n.track.chart.canvas.width,n.getHeight())},draw:function(){for(var t,i,r=this.track.chart.scale.min,u=this.track.chart.scale.max,f=!1,n=0;n<this.features.length;n++)t=this.features[n].position,i=this.features[n].getEnd(),(t>=r&&t<=u||i>=r&&i<=u)&&(this.features[n].draw(),f=!0);return f},filterFeaturesByPosition:function(n,t){for(var u,f,r=this,e=[],o=r.features.length,i=0;i<o;i++)u=r.features[i].position,f=r.features[i].getEnd(),(u>=n&&u<=t||f>=n&&f<=t)&&e.push(r.features[i]);return e}}),Tooltip=Class.extend({init:function(n,t,i,r){var u=this,f;u.text=n;u.placement=t||"above";u.verticalOffset=i||0;for(f in r)u[f]=r[f];u.horizontalOffset=u.horizontalOffset||0;u.ntOffset=u.ntOffset||0},fire:function(n){var t=n||this.feature;this.chart=t.lane.track.chart;this.ctx=this.chart.ctx;this.draw(t,1)},draw:function(n,t){var w,i,r,d,a,s,y;this.ctx.globalAlpha=t;var e=this.chart.tooltips.roundness,k=this.chart.tooltips.text.font,c=this.chart.tooltips.text.size,v=this.text||n.onMouseover;this.ctx.save();this.ctx.font=c+"px "+k;var y=this.ctx.measureText(v),l=[v],f=c+10,u=y.width+10,tt=f-4,o,h,p=0;if(n.seq&&(w=n.getPixelLength(),p=this.ntOffset*(w/n.length)),i=n.getPixelPositionX()+this.horizontalOffset+p,r=this.placement=="below"?n.getPixelPositionY()+n.getHeight()-this.verticalOffset:n.getPixelPositionY()-f-this.verticalOffset,d=n.getPixelLength(),a=200,u>a){var g=this.ctx.measureText("s").width,nt=parseInt(a/g),b=ScriblWrapLines(nt,v);u=a+10;f=b[1]*c+10;l=b[0]}for(u+i>this.chart.width&&(i=this.chart.width-u),this.chart.tooltips.style=="light"?(o=this.chart.ctx.createLinearGradient(i+u/2,r,i+u/2,r+f),o.addColorStop(0,"rgb(253, 248, 196)"),o.addColorStop(.75,"rgb(253, 248, 196)"),o.addColorStop(1,"white"),h=this.chart.ctx.createLinearGradient(i+u/2,r,i+u/2,r+f),h.addColorStop(0,"black"),h.addColorStop(1,"rgb(64, 64, 64)"),this.chart.tooltips.text.color="black"):this.chart.tooltips.style=="dark"&&(o=this.chart.ctx.createLinearGradient(i+u/2,r,i+u/2,r+f),o.addColorStop(0,"rgb(64, 64, 64)"),o.addColorStop(1,"rgb(121, 121, 121)"),h="white",this.chart.tooltips.text.color="white"),this.chart.lastToolTips.push({pixels:this.ctx.getImageData(i-1,r-1,u+2,f+2),x:i-1,y:r-1}),this.ctx.fillStyle=o,this.ctx.beginPath(),tlc_ctrl_x=i,tlc_ctrl_y=r,tlc_lgth_x=i+e,tlc_lgth_y=r,tlc_wdth_x=i,tlc_wdth_y=r+e,blc_ctrl_x=i,blc_ctrl_y=r+f,blc_lgth_x=i+e,blc_lgth_y=r+f,blc_wdth_x=i,blc_wdth_y=r+f-e,brc_ctrl_x=i+u,brc_ctrl_y=r+f,brc_lgth_x=i+u-e,brc_lgth_y=r+f,brc_wdth_x=i+u,brc_wdth_y=r+f-e,trc_ctrl_x=i+u,trc_ctrl_y=r,trc_lgth_x=i+u-e,trc_lgth_y=r,trc_wdth_x=i+u,trc_wdth_y=r+e,this.ctx.moveTo(tlc_lgth_x,tlc_lgth_y),this.ctx.quadraticCurveTo(tlc_ctrl_x,tlc_ctrl_y,tlc_wdth_x,tlc_wdth_y),this.ctx.lineTo(blc_wdth_x,blc_wdth_y),this.ctx.quadraticCurveTo(blc_ctrl_x,blc_ctrl_y,blc_lgth_x,blc_lgth_y),this.ctx.lineTo(brc_lgth_x,brc_lgth_y),this.ctx.quadraticCurveTo(brc_ctrl_x,brc_ctrl_y,brc_wdth_x,brc_wdth_y),this.ctx.lineTo(trc_wdth_x,trc_wdth_y),this.ctx.quadraticCurveTo(trc_ctrl_x,trc_ctrl_y,trc_lgth_x,trc_lgth_y),this.ctx.lineTo(tlc_lgth_x,tlc_lgth_y),this.ctx.fill(),this.ctx.lineWidth=this.chart.tooltips.borderWidth,this.ctx.strokeStyle=h,this.ctx.stroke(),this.ctx.textBaseline="middle",this.ctx.fillStyle=this.chart.tooltips.text.color,s=0;s<l.length;s++)y=this.ctx.measureText(l[s]),this.ctx.fillText(l[s],i+5,r+c*(s+1));this.ctx.restore()}}),MouseEventHandler=Class.extend({init:function(n){this.chart=n;this.mouseX=null;this.mouseY=null;this.eventElement=undefined;this.isEventDetected=!1;this.tooltip=new Tooltip("","above",-4)},addEvents:function(n){var t=this.chart,r=t.ctx,i=t.myMouseEventHandler;n.onMouseover&&!t.events.hasMouseover?(t.addMouseoverEventListener(t.myMouseEventHandler.handleMouseover),t.events.hasMouseover=!0):n.tooltips.length>0&&!t.events.hasMouseover?(t.addMouseoverEventListener(t.myMouseEventHandler.handleMouseover),t.events.hasMouseover=!0):n.parent&&n.parent.tooltips.length>0&&!t.events.hasMouseover?(t.addMouseoverEventListener(t.myMouseEventHandler.handleMouseover),t.events.hasMouseover=!0):n.parent&&n.parent.onMouseover&&!t.events.hasMouseover&&(t.addMouseoverEventListener(t.myMouseEventHandler.handleMouseover),t.events.hasMouseover=!0);n.onClick&&!t.events.hasClick?(t.addClickEventListener(t.myMouseEventHandler.handleClick),t.addMouseoverEventListener(t.myMouseEventHandler.handleMouseStyle),t.events.hasClick=!0):n.parent&&n.parent.onClick&&!t.events.hasClick&&(t.addClickEventListener(t.myMouseEventHandler.handleClick),t.addMouseoverEventListener(t.myMouseEventHandler.handleMouseStyle),t.events.hasClick=!0);!i.isEventDetected&&r.isPointInPath_mozilla(i.mouseX,i.mouseY)&&(i.eventElement=n,i.isEventDetected=!0)},setMousePosition:function(n){if(n!=null){var t=this.chart.canvas.getBoundingClientRect();this.mouseX=n.clientX-t.left;this.mouseY=n.clientY-t.top}},handleClick:function(n){var r=n.myMouseEventHandler,t=r.eventElement,i;t!=undefined&&t.onClick!=undefined?i=t.onClick:t&&t.parent&&t.parent.onClick&&(i=t.parent.onClick);i&&(typeof i=="string"?window.open(i):typeof i=="function"&&i(t))},handleMouseover:function(n){var i=n.myMouseEventHandler,t=i.eventElement;if(t&&t.onMouseover==undefined&&t.parent&&t.parent.onMouseover&&(t.onMouseover=t.parent.onMouseover),t&&t.onMouseover)if(typeof t.onMouseover=="string")i.tooltip.fire(t);else if(typeof t.onMouseover=="function")t.onMouseover(t);t&&t.tooltips.length>0&&t.fireTooltips()},handleMouseStyle:function(n){var i=n.myMouseEventHandler,t=i.eventElement,r=n.ctx;r.canvas.style.cursor=t&&t.onClick!=undefined?"pointer":t&&t.parent&&t.parent.onClick!=undefined?"pointer":"auto"},reset:function(n){var t=n.myMouseEventHandler;t.mouseX=null;t.mouseY=null;t.eventElement=undefined;t.isEventDetected=null;t.elementIndexCounter=0}});CanvasRenderingContext2D.prototype.isPointInPath_mozilla=function(n,t){var i;return navigator.userAgent.indexOf("Firefox")!=-1?(this.save(),this.setTransform(1,0,0,1,0,0),i=this.isPointInPath(n,t),this.restore()):i=this.isPointInPath(n,t),i};idCounter=0;_uniqueId=function(n){var t=idCounter++;return n?n+t:t};Object.keys=Object.keys||function(n,t,i){i=[];for(t in n)i.hasOwnProperty.call(n,t)&&i.push(t);return i};Array.prototype.indexOf||(Array.prototype.indexOf=function(n){"use strict";var u,r,t,i;if(this===void 0||this===null)throw new TypeError;if((u=Object(this),r=u.length>>>0,r===0)||(t=0,arguments.length>0&&(t=Number(arguments[1]),t!==t?t=0:t!==0&&t!==Infinity&&t!==-Infinity&&(t=(t>0||-1)*Math.floor(Math.abs(t)))),t>=r))return-1;for(i=t>=0?t:Math.max(r-Math.abs(t),0);i<r;i++)if(i in u&&u[i]===n)return i;return-1});var CanvasToSVG={idCounter:0,convert:function(n,t,i,r){var f=n.toDataURL(),u=document.createElementNS("http://www.w3.org/2000/svg","image");u.setAttribute("id","importedCanvas_"+this.idCounter++);u.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",f);u.setAttribute("x",i?i:0);u.setAttribute("y",r?r:0);u.setAttribute("width",n.width);u.setAttribute("height",n.height);u.imageData=n.toDataURL();t.appendChild(u)}},toXml=function(n){return $("<p/>").text(n).html()},svgToString=function(n){for(var t,i;removeUnusedDefElems()>0;);return pathActions.clear(!0),$.each(n.childNodes,function(t,i){t&&i.nodeType==8&&i.data.indexOf("Created with")>=0&&n.insertBefore(i,n.firstChild)}),current_group&&(leaveContext(),selectOnly([current_group])),t=[],$(n).find("g:data(gsvg)").each(function(){for(var u,i=this.attributes,r=i.length,n=0;n<r;n++)(i[n].nodeName=="id"||i[n].nodeName=="style")&&r--;r<=0&&(u=this.firstChild,t.push(u),$(this).replaceWith(u))}),i=svgToString(n,0),t.length&&$(t).each(function(){groupSvgElem(this)}),i},svgToString=function(n,t){var i=[],e,u,o,h,c,f,l,s,a,r;if(n){for(e=n.attributes,o=n.childNodes,r=0;r<t;r++)i.push(" ");if(i.push("<"),i.push(n.nodeName),n.id=="svgcontent")for(h=getResolution(),i.push(' width="'+h.w+'" height="'+h.h+'" xmlns="'+svgns+'"'),c={},$(n).find("*").andSelf().each(function(){var n=this;$.each(this.attributes,function(n,t){var r=t.namespaceURI;r&&!c[r]&&nsMap[r]!=="xmlns"&&nsMap[r]!=="xml"&&(c[r]=!0,i.push(" xmlns:"+nsMap[r]+'="'+r+'"'))})}),r=e.length;r--;)(u=e.item(r),f=toXml(u.nodeValue),u.nodeName.indexOf("xmlns:")!==0)&&f!=""&&["width","height","xmlns","x","y","viewBox","id","overflow"].indexOf(u.localName)==-1&&(!u.namespaceURI||nsMap[u.namespaceURI])&&(i.push(" "),i.push(u.nodeName),i.push('="'),i.push(f),i.push('"'));else for(r=e.length-1;r>=0;r--)if((u=e.item(r),f=toXml(u.nodeValue),!(["-moz-math-font-style","_moz-math-font-style"].indexOf(u.localName)>=0))&&f!=""){if(f.indexOf("pointer-events")===0)continue;if(u.localName==="class"&&f.indexOf("se_")===0)continue;i.push(" ");u.localName==="d"&&(f=pathActions.convertPath(n,!0));i.push(u.nodeName);i.push('="');i.push(f);i.push('"')}if(n.hasChildNodes()){for(i.push(">"),t++,l=!1,r=0;r<o.length;r++){s=o.item(r);switch(s.nodeType){case 1:i.push("\n");i.push(svgToString(o.item(r),t));break;case 3:a=s.nodeValue.replace(/^\s+|\s+$/g,"");a!=""&&(l=!0,i.push(toXml(a)+""));break;case 8:i.push("\n");i.push(new Array(t+1).join(" "));i.push("<!--");i.push(s.data);i.push("-->")}}if(t--,!l)for(i.push("\n"),r=0;r<t;r++)i.push(" ");i.push("<\/");i.push(n.nodeName);i.push(">")}else i.push("/>")}return i.join("")},Glyph=Class.extend({init:function(n,t,i,r,u){var f=this,e;this.uid=_uniqueId("feature");f.position=t;f.length=i;f.strand=r;this.type=n;f.opts={};f.name="";f.borderColor="none";f.borderWidth=undefined;f.ntLevel=4;f.tooltips=[];f.hooks={};f.addDrawHook(function(n){if(n.ntLevel!=undefined&&n.seq&&n.lane.chart.ntsToPixels()<n.ntLevel){var t=new Seq(n.type,n.position,n.length,n.seq,n.opts);return t.lane=n.lane,t.ctx=n.ctx,t._draw(),!0}return!1},"ntHook");f.text={};f.text.font=undefined;f.text.size=undefined;f.text.color=undefined;f.text.align=undefined;f.onClick=undefined;f.onMouseover=undefined;for(e in u)f[e]=u[e],f.opts[e]=u[e]},setColorGradient:function(){var t,i,n;if(arguments.length==1){this.color=arguments[0];return}for(t=this.lane.ctx.createLinearGradient(this.length/2,0,this.length/2,this.getHeight()),n=0;i=arguments[n],n<arguments.length;n++)t.addColorStop(n/(arguments.length-1),i);this.color=t},getPixelLength:function(){var n=this;return n.lane.chart.pixelsToNts(n.length)||1},getPixelPositionX:function(){var n=this,i=parseInt(n.lane.track.chart.offset)||0,t;return t=n.parent?n.position+n.parent.position-n.lane.track.chart.scale.min:n.position-n.lane.track.chart.scale.min,n.lane.track.chart.pixelsToNts(t)+i},getPixelPositionY:function(){var n=this;return n.lane.getPixelPositionY()},getEnd:function(){return this.position+this.length},clone:function(glyphType){var glyph=this,newFeature,str,attrs,i;if(glyphType=glyphType||glyph.glyphType,(glyphType=="Rect"||glyphType=="Line")&&(glyph.strand=undefined),glyph.strand)for(str="new "+glyphType+'("'+glyph.type+'",'+glyph.position+","+glyph.length+',"'+glyph.strand+'",'+JSON.stringify(glyph.opts)+")",newFeature=eval(str),attrs=Object.keys(glyph),i=0;i<attrs.length;i++)newFeature[attrs[i]]=glyph[attrs[i]];else for(str="new "+glyphType+'("'+glyph.type+'",'+glyph.position+","+glyph.length+","+JSON.stringify(glyph.opts)+")",newFeature=eval(str),attrs=Object.keys(glyph),i=0;i<attrs.length;i++)newFeature[attrs[i]]=glyph[attrs[i]];return newFeature.tooltips=glyph.tooltips,newFeature.hooks=glyph.hooks,newFeature},getAttr:function(n){for(var f,r,e,u=this,i=n.split("-"),o=u,t=0;t<i.length;t++)o=o[i[t]];if(o)return o;if(u.parent){for(f=u.parent,t=0;t<i.length;t++)f=f[i[t]];if(f)return f}if(r=this.lane.chart[u.type],r){for(t=0;t<i.length;t++)r=r[i[t]];if(r)return r}for(e=u.lane.chart.glyph,t=0;t<i.length;t++)e=e[i[t]];return e?e:undefined},drawText:function(n){var i=this,t=i.lane.chart.ctx,e=5,o=i.getPixelLength(),l=i.getHeight(),f=i.getAttr("text-size"),a=i.getAttr("text-style"),u,r,s,h,c;if(t.font=f+"px "+a,t.textBaseline="middle",t.fillStyle=i.getAttr("text-color"),u=undefined,r=i.getAttr("text-align"),r=="start"?r=i.strand=="+"?"left":"right":r=="end"&&(r=i.strand=="+"?"right":"left"),t.textAlign=r,r=="left"?u=0+e:r=="center"?u=o/2:r=="right"&&(u=o-e),s=t.measureText(n),n&&n!=""){while(o-s.width<4)if(f=/^\d+/.exec(t.font),f--,s=t.measureText(n),t.font=f+"px "+a,f<=8){n="";break}i.glyphType=="Complex"&&(h=0,c=/^\d+/.exec(t.font),r=="center"&&(h=-(t.measureText(n).width/2+e/2)),t.clearRect(u+h,l/2-c/2,t.measureText(n).width+e,c));t.fillText(n,u,l/2)}},calcRoundness:function(){var n=this.getHeight()*this.getAttr("roundness")/100;return(n*10%5>=2.5?parseInt(n*2)*5+5:parseInt(n*2)*5)/10},isContainedWithinRect:function(n,t,i,r){var u=this,f=u.getPixelPositionY(),e=u.getPixelPositionX(),o=f,s=u.getPixelPositionX()+u.getPixelLength(),h=f+u.getHeight();return e>=n&&s<=i&&o>=t&&h<=r},getHeight:function(){var n=this;return n.lane.getHeight()},getFillStyle:function(){var u=this,n=u.getAttr("color"),r,i,t;if(n instanceof Array){for(t=this.lane.track.chart.ctx.createLinearGradient(this.length/2,0,this.length/2,this.getHeight()),i=0;r=n[i],i<n.length;i++)t.addColorStop(i/(n.length-1),r);return t}return n instanceof Function?(t=this.lane.track.chart.ctx.createLinearGradient(this.length/2,0,this.length/2,this.getHeight()),n(t)):n},getStrokeStyle:function(){var u=this,n=u.getAttr("borderColor"),i,r,t;if(typeof n=="object"){for(i=this.lane.ctx.createLinearGradient(this.length/2,0,this.length/2,this.getHeight()),t=0;r=n[t],t<n.length;t++)i.addColorStop(t/(n.length-1),r);return i}return n},isSubFeature:function(){return this.parent!=undefined},erase:function(){var n=this;n.ctx.save();n.ctx.setTransform(1,0,0,1,0,0);n.ctx.clearRect(n.getPixelPositionX(),n.getPixelPositionY(),n.getPixelLength(),n.getHeight());n.ctx.restore()},addDrawHook:function(n,t){var i=t||_uniqueId("drawHook");return this.hooks[i]=n,i},removeDrawHook:function(n){delete this.hooks[n]},addTooltip:function(n,t,i,r){var u=this,f=new Tooltip(n,t,i,r);f.feature=u;u.tooltips.push(f)},fireTooltips:function(){for(var n=0;n<this.tooltips.length;n++)this.tooltips[n].fire()},draw:function(){var n=this,t,e,o,s;n.ctx=n.lane.chart.ctx;n.ctx.beginPath();var c=/^\d+/.exec(n.ctx.font),i=/\S+$/.exec(n.ctx.font),r=10;n.onClick=n.getAttr("onClick");n.onMouseover=n.getAttr("onMouseover");n.ctx.fillStyle=n.getFillStyle();var h=n.ctx.fillStyle,u=n.getPixelPositionX(),f=n.getHeight();n.ctx.font=f<r?r+"px "+i:f*.9+"px "+i;n.ctx.translate(u,0);n.strand!="-"||n.isSubFeature()||n.ctx.transform(-1,0,0,1,n.getPixelLength(),0);t=!1;for(e in n.hooks)t=n.hooks[e](n)||t;t||n._draw();n.borderColor!="none"&&(n.color=="none"&&n.parent.glyphType=="Complex"&&n.erase(),o=n.ctx.strokeStyle,s=n.ctx.lineWidth,n.ctx.strokeStyle=n.getStrokeStyle(),n.ctx.lineWidth=n.getAttr("borderWidth"),n.ctx.stroke(),n.ctx.strokeStyle=o,n.ctx.lineWidth=s);n.color!="none"&&n.ctx.fill();n.strand!="-"||n.isSubFeature()||n.ctx.transform(-1,0,0,1,n.getPixelLength(),0);n.drawText(n.getAttr("name"));n.ctx.translate(-u,0);n.ctx.fillStyle=h;n.lane.chart.myMouseEventHandler.addEvents(this)},redraw:function(){var n=this,t;n.lane.ctx.save();n.erase;t=n.getPixelPositionY();n.lane.ctx.translate(0,t);n.draw();n.lane.ctx.restore()}}),BlockArrow=Glyph.extend({init:function(n,t,i,r,u){this._super(n,t,i,r,u);this.slope=1;this.glyphType="BlockArrow"},_draw:function(n,i,r,u){var f=this,n=n||f.ctx,i=i||f.getPixelLength(),r=r||f.getHeight(),u=u+1||f.calcRoundness(),o,e;if(u!=undefined&&(u-=1),o=i*.75,x=y=0,tc_ctrl_x=x,tc_ctrl_y=y,tc_lgth_x=x+u,tc_lgth_y=y,tc_wdth_x=x,tc_wdth_y=y+u,bc_ctrl_x=x,bc_ctrl_y=y+r,bc_lgth_x=x+u,bc_lgth_y=y+r,bc_wdth_x=x,bc_wdth_y=y+r-u,a_b_x=x+i-u,a_t_x=x+i-u,a_max_x=x+i,t=.5,a_ctrl_x=Math.round((a_max_x-(1-t)*(1-t)*a_b_x-t*t*a_t_x)/(2*(1-t)*t)*10)/10,a_ctrl_y=y+r/2,bs_slope=f.slope,bs_intercept=-a_ctrl_y-bs_slope*a_ctrl_x,ts_slope=-f.slope,ts_intercept=-a_ctrl_y-ts_slope*a_ctrl_x,a_b_y=-(Math.round((bs_slope*a_b_x+bs_intercept)*10)/10),a_t_y=-(Math.round((ts_slope*a_t_x+ts_intercept)*10)/10),bs_ctrl_y=y+r,bs_ctrl_x=(-bs_ctrl_y-bs_intercept)/f.slope,bs_ctrl_x<x){e=new Rect(f.type,0,i);e._draw(n,i,r,u);return}bs_lgth_y=y+r;bs_lgth_x=bs_ctrl_x-u;bs_slpe_x=bs_ctrl_x+u;bs_slpe_y=-(Math.round((bs_slope*bs_slpe_x+bs_intercept)*10)/10);ts_ctrl_y=y;ts_ctrl_x=(ts_ctrl_y+ts_intercept)/f.slope;ts_lgth_y=y;ts_lgth_x=ts_ctrl_x-u;ts_slpe_x=ts_ctrl_x+u;ts_slpe_y=-(Math.round((ts_slope*ts_slpe_x+ts_intercept)*10)/10);n.beginPath();n.moveTo(tc_lgth_x,tc_lgth_y);n.quadraticCurveTo(tc_ctrl_x,tc_ctrl_y,tc_wdth_x,tc_wdth_y);n.lineTo(bc_wdth_x,bc_wdth_y);n.quadraticCurveTo(bc_ctrl_x,bc_ctrl_y,bc_lgth_x,bc_lgth_y);n.lineTo(bs_lgth_x,bs_lgth_y);n.quadraticCurveTo(bs_ctrl_x,bs_ctrl_y,bs_slpe_x,bs_slpe_y);n.lineTo(a_b_x,a_b_y);n.quadraticCurveTo(a_ctrl_x,a_ctrl_y,a_t_x,a_t_y);n.lineTo(ts_slpe_x,ts_slpe_y);n.quadraticCurveTo(ts_ctrl_x,ts_ctrl_y,ts_lgth_x,ts_lgth_y);n.lineTo(tc_lgth_x,tc_lgth_y)}}),Rect=Glyph.extend({init:function(n,t,i,r){this._super(n,t,i,undefined,r);this.glyphType="Rect"},_draw:function(n,t,i,r){var u=this,n=n||u.ctx,t=t||u.getPixelLength(),i=i||u.getHeight(),r=r+1||u.calcRoundness();r!=undefined&&(r-=1);x=y=0;n.beginPath();tlc_ctrl_x=x;tlc_ctrl_y=y;tlc_lgth_x=x+r;tlc_lgth_y=y;tlc_wdth_x=x;tlc_wdth_y=y+r;blc_ctrl_x=x;blc_ctrl_y=y+i;blc_lgth_x=x+r;blc_lgth_y=y+i;blc_wdth_x=x;blc_wdth_y=y+i-r;brc_ctrl_x=x+t;brc_ctrl_y=y+i;brc_lgth_x=x+t-r;brc_lgth_y=y+i;brc_wdth_x=x+t;brc_wdth_y=y+i-r;trc_ctrl_x=x+t;trc_ctrl_y=y;trc_lgth_x=x+t-r;trc_lgth_y=y;trc_wdth_x=x+t;trc_wdth_y=y+r;n.moveTo(tlc_lgth_x,tlc_lgth_y);n.quadraticCurveTo(tlc_ctrl_x,tlc_ctrl_y,tlc_wdth_x,tlc_wdth_y);n.lineTo(blc_wdth_x,blc_wdth_y);n.quadraticCurveTo(blc_ctrl_x,blc_ctrl_y,blc_lgth_x,blc_lgth_y);n.lineTo(brc_lgth_x,brc_lgth_y);n.quadraticCurveTo(brc_ctrl_x,brc_ctrl_y,brc_wdth_x,brc_wdth_y);n.lineTo(trc_wdth_x,trc_wdth_y);n.quadraticCurveTo(trc_ctrl_x,trc_ctrl_y,trc_lgth_x,trc_lgth_y);n.lineTo(tlc_lgth_x,tlc_lgth_y)}}),Seq=Glyph.extend({init:function(n,t,i,r,u){this.seq=r;this.insertions=[];this.fraction=1;this.fractionLevel=.3;this.glyphType="Seq";this.font="8px courier";this.chars={};this.chars.width=undefined;this.chars.height=undefined;this.chars.list=["A","G","T","C","N","-"];this._super(n,t,i,undefined,u)},_draw:function(n,t,i){var r=this,o=1,s,c,a,l,v,p,u,h,g;r.lane.chart.ntsToPixels()<=r.fractionLevel&&(o=this.fraction);var n=n||r.ctx,t=t||r.getPixelLength(),i=i||r.getHeight(),b=r.getPixelPositionX(),k=r.getPixelPositionY(),f=SCRIBL.chars;if(!f.heights[i])for(f.heights[i]=[],u=0;u<this.chars.list.length;u++)s=this.chars.list[u],c=s,s=="-"&&(c="dash"),a="nt_"+c+"_bg",this.createChar(s,f.nt_color,f[a],i);if(x=y=0,r.imgCanvas)n.drawImage(r.imgCanvas,b,k-i*o,t,i*o);else{n.save();n.beginPath();n.textBaseline="middle";l=n.font;v=/[\d+px]/.exec(l)+"px";n.font=v+" courier";n.fillStyle="black";n.textAlign="left";p=this.seq.length*f.heights[i].width;r.imgCanvas=document.createElement("canvas");r.imgCanvas.width=p;r.imgCanvas.height=i;var d=r.imgCanvas.getContext("2d"),w=0,e=0;for(u=0;u<this.seq.length;u++)f.heights[i][this.seq[u]]||this.createChar(this.seq[u],"black","white",i),h=this.seq[u],this.insertions.length>1&&(g=2),this.insertions[e]&&this.insertions[e].pos!=undefined&&(this.insertions[e].pos-1==u?h+="rightInsert":this.insertions[e]&&this.insertions[e].pos==u&&(h+="leftInsert",e++)),d.drawImage(f.heights[i][h],w,y),w+=f.heights[i].width;n.drawImage(r.imgCanvas,x,i-i*o,t,i*o);n.font=l;n.restore()}n.beginPath();n.moveTo(0,0);n.lineTo(t,y);n.lineTo(t,y+i);n.lineTo(x,y+i);n.lineTo(x,y);n.fillStyle="rgba(0,0,0,0)";n.strokeStyle=r.lane.chart.ntsToPixels()<=r.fractionLevel?"rgba(0,0,0,1)":"rgba(0,0,0,0)";n.stroke();n.closePath()},createChar:function(n,t,i,r){var c=this,l=c.lane.track.chart,f=document.createElement("canvas"),u=f.getContext("2d"),h=2,s=r-h,e,o;u.font=s+"px courier";e=u.measureText(n).width+h;f.height=r;f.width=e;SCRIBL.chars.heights[r].width=e;f=document.createElement("canvas");u=f.getContext("2d");u.font=s+"px courier";f.height=r;f.width=e;o=u.fillStyle;u.fillStyle=i;u.fillRect(0,0,e,r);u.fillStyle=t;u.textAlign="center";u.textBaseline="middle";u.fillText(n,e/2,r/2);SCRIBL.chars.heights[r][n]=f;u.fillStyle=o;f=document.createElement("canvas");u=f.getContext("2d");u.font=s+"px courier";f.height=r;f.width=e;o=u.fillStyle;u.fillStyle=i;u.fillRect(0,0,e,r);u.fillStyle="yellow";u.beginPath();u.moveTo(0,r);u.arcTo(e,r,e,0,r/2);u.lineTo(e,r);u.lineTo(0,r);u.closePath();u.fill();u.fillStyle=t;u.textAlign="center";u.textBaseline="middle";u.fillText(n,e/2,r/2);SCRIBL.chars.heights[r][n+"rightInsert"]=f;u.fillStyle=o;f=document.createElement("canvas");u=f.getContext("2d");u.font=s+"px courier";f.height=r;f.width=e;o=u.fillStyle;u.fillStyle=i;u.fillRect(0,0,e,r);u.fillStyle="yellow";u.beginPath();u.moveTo(e,r);u.arcTo(0,r,0,0,r/2);u.lineTo(0,r);u.lineTo(e,r);u.closePath();u.fill();u.fillStyle=t;u.textAlign="center";u.textBaseline="middle";u.fillText(n,e/2,r/2);SCRIBL.chars.heights[r][n+"leftInsert"]=f;u.fillStyle=o}}),Line=Glyph.extend({init:function(n,t,i,r){this.thickness=2;this._super(n,t,i,undefined,r);this.glyphType="Line"},_draw:function(n,t,i){var r=this,n=n||r.ctx,t=t||r.getPixelLength(),i=i||r.getHeight();x=y=0;n.beginPath();n.moveTo(x,i/2-r.thickness/2);n.lineTo(x,i/2+r.thickness/2);n.lineTo(x+t,i/2+r.thickness/2);n.lineTo(x+t,i/2-r.thickness/2)}}),Complex=Glyph.extend({init:function(n,t,i,r,u,f){this._super(n,t,i,r,f);this.slope=1;this.glyphType="Complex";this.subFeatures=u;this.line=new Line(n,0,i);this.line.parent=this;this.line.color="black";this.line.thickness=2},addSubFeature:function(n){this.subFeatures.push(n)},_draw:function(n,t,i,r){var u=this,n=n||u.ctx,t=t||u.getPixelLength(),i=i||u.getHeight(),r=r+1||u.calcRoundness(),e,f;for(r!=undefined&&(r-=1),x=y=0,n.translate(-u.getPixelPositionX(),0),u.line.lane=this.lane,u.line.draw(),e=u.subFeatures.length,f=0;f<e;f++)u.subFeatures[f].parent=u,u.subFeatures[f].lane=u.lane,u.subFeatures[f].draw();n.translate(u.getPixelPositionX(),0);n.beginPath()}}),Arrow=Glyph.extend({init:function(n,t,i,r){this._super(n,t,0,i,r);this.slope=1;this.glyphType="Arrow";this.thickness=4.6},getPixelThickness:function(){var n=this,t=n.getHeight(),i=t/2/Math.tan(Math.atan(n.slope));return n.thickness/10*i},erase:function(){var n=this,t=n.getPixelThickness();n.ctx.clearRect(-t,0,t,n.getHeight())},_draw:function(n,i,r,u){var f=this,n=n||f.ctx,r=r||f.getHeight(),u=u+1||f.calcRoundness(),e,o,l,a;u!=undefined&&(u-=1);e=f.getPixelThickness();o=0;x=y=0;a_b_x=x-o-u;a_t_x=x-o-u;a_max_x=x-o;t=.5;a_ctrl_x=(a_max_x-(1-t)*(1-t)*a_b_x-t*t*a_t_x)/(2*(1-t)*t);a_ctrl_y=y+r/2;bs_slope=f.slope;bs_intercept=-a_ctrl_y-bs_slope*a_ctrl_x;ts_slope=-f.slope;ts_intercept=-a_ctrl_y-ts_slope*a_ctrl_x;a_b_y=-(bs_slope*a_b_x+bs_intercept);a_t_y=-(ts_slope*a_t_x+ts_intercept);n.beginPath();bs_ctrl_y=y+r;bs_ctrl_x=(-bs_ctrl_y-bs_intercept)/f.slope;bs_slpe_x=bs_ctrl_x+u+u;bs_slpe_y=-(bs_slope*bs_slpe_x+bs_intercept);n.moveTo(bs_slpe_x,bs_slpe_y);n.lineTo(a_b_x,a_b_y);n.quadraticCurveTo(a_ctrl_x,a_ctrl_y,a_t_x,a_t_y);ts_ctrl_y=y;ts_ctrl_x=(ts_ctrl_y+ts_intercept)/f.slope;ts_slpe_x=ts_ctrl_x+u+u;ts_slpe_y=-(ts_slope*ts_slpe_x+ts_intercept);n.lineTo(ts_slpe_x,ts_slpe_y);var c=Math.PI-Math.abs(Math.atan(f.slope))-Math.PI/2,s=Math.sin(c)*e,h=Math.cos(c)*e,v=ts_slpe_x-s,p=ts_slpe_y+h;n.bezierCurveTo(ts_ctrl_x,ts_ctrl_y,ts_ctrl_x-s,ts_ctrl_y+h,v,p);n.lineTo(a_max_x-e,y+r/2);l=bs_slpe_x-s;a=bs_slpe_y-h;n.lineTo(l,a);n.bezierCurveTo(bs_ctrl_x-s,bs_ctrl_y-h,bs_ctrl_x,bs_ctrl_y,bs_slpe_x,bs_slpe_y)}});
/*
//# sourceMappingURL=Scribl.1.1.4.min.js.map
*/